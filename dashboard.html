
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mario Math: Parent Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Verdana&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Verdana', sans-serif; background: #f0f2f5; padding: 20px; text-align: center; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 5px; }
        .sub-header { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        
        #login-section { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 50px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 250px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }

        #dashboard-section { display: none; text-align: left; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
        .card h3 { margin: 0; font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .card .number { font-size: 2em; font-weight: bold; color: #333; margin-top: 5px; }

        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; font-weight: bold; color: #666; border: none; background: none; font-size: 1em; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn:hover { color: #007bff; background: #f1f1f1; }
        .tab-btn.active { color: #007bff; border-bottom: 3px solid #007bff; }

        .view-container { display: none; animation: fadeIn 0.3s; }
        .view-container.active { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #007bff; color: white; position: sticky; top: 0; cursor: pointer; user-select: none; }
        th:hover { background-color: #0056b3; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e2e6ea; }

        .progress-bar-bg { width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; transition: width 0.5s; }

        .bad-score { color: red; font-weight: bold; }
        .good-score { color: green; font-weight: bold; }
        
        .sort-icon { font-size: 0.8em; margin-left: 5px; opacity: 0.7; }

        #session-detail-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border-radius: 10px; border: 1px solid #888; width: 80%; max-width: 700px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .tabs { flex-direction: column; }
            .tab-btn { border-bottom: 1px solid #ddd; }

            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 10px; }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; min-height: 25px; }
            td:before { position: absolute; top: 6px; left: 6px; width: 45%; padding-right: 10px; white-space: nowrap; font-weight: bold; }

            #category-table td:nth-of-type(1):before { content: "Category"; }
            #category-table td:nth-of-type(2):before { content: "Attempts"; }
            #category-table td:nth-of-type(3):before { content: "Accuracy"; }
            #category-table td:nth-of-type(4):before { content: "Status"; }

            #questions-table td:nth-of-type(1):before { content: "Question"; }
            #questions-table td:nth-of-type(2):before { content: "Category"; }
            #questions-table td:nth-of-type(3):before { content: "Attempts"; }
            #questions-table td:nth-of-type(4):before { content: "Correct"; }
            #questions-table td:nth-of-type(5):before { content: "Wrong"; }
            #questions-table td:nth-of-type(6):before { content: "Accuracy"; }

            #sessions-table td:nth-of-type(1):before { content: "Session Date"; }
            #sessions-table td:nth-of-type(2):before { content: "Duration"; }
            #sessions-table td:nth-of-type(3):before { content: "Questions"; }
            #sessions-table td:nth-of-type(4):before { content: "Accuracy"; }
            #sessions-table td:nth-of-type(5):before { content: "Action"; }

            #session-detail-table td:nth-of-type(1):before { content: "Question"; }
            #session-detail-table td:nth-of-type(2):before { content: "Result"; }
            #session-detail-table td:nth-of-type(3):before { content: "Time"; }
            
            .modal-content { margin: 5% auto; width: 95%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üìä Parent Dashboard</h1>
        <div class="sub-header">Review Mario Math Performance</div>

        <div id="login-section">
            <p><strong>Checking Login...</strong></p>
            <div id="manual-login" style="display:none; flex-direction:column; align-items:center; gap:10px;">
                <input type="email" id="email" placeholder="Email" value="mario@math.com">
                <input type="password" id="password" placeholder="Password">
                <button onclick="loginAndFetch()">LOGIN</button>
                <p id="error-msg" style="color:red; font-size: 0.8em;"></p>
            </div>
        </div>

        <div id="dashboard-section">
            <div class="summary-cards">
                <div class="card"><h3>Total Answered</h3><div class="number" id="total-q">0</div></div>
                <div class="card"><h3>Global Accuracy</h3><div class="number" id="total-acc">0%</div></div>
                <div class="card"><h3>Strongest Area</h3><div class="number" id="top-subject" style="font-size:1.2em; line-height: 2rem;">-</div></div>
                <div class="card"><h3>Total Sessions</h3><div class="number" id="total-sessions">0</div></div>
                <div class="card"><h3>Avg. Session</h3><div class="number" id="avg-duration">0m</div></div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('category')">üìÇ By Category</button>
                <button class="tab-btn" onclick="switchTab('questions')">‚ùì All Questions</button>
                <button class="tab-btn" onclick="switchTab('sessions')">üìÖ By Session</button>
            </div>

            <div id="view-category" class="view-container active">
                <table id="category-table"><thead><tr><th>Category</th><th>Attempts</th><th>Accuracy</th><th>Status</th></tr></thead><tbody id="cat-table-body"></tbody></table>
            </div>

            <div id="view-questions" class="view-container">
                <p style="font-size:0.8em; color:#666; margin-bottom:10px;">Click headers to sort.</p>
                <table id="questions-table"><thead><tr><th onclick="sortQuestions('text')">Question <span class="sort-icon">‚áÖ</span></th><th onclick="sortQuestions('category')">Category <span class="sort-icon">‚áÖ</span></th><th onclick="sortQuestions('total')">Attempts <span class="sort-icon">‚ñº</span></th><th onclick="sortQuestions('correct')">Correct <span class="sort-icon">‚áÖ</span></th><th onclick="sortQuestions('wrong')">Wrong <span class="sort-icon">‚áÖ</span></th><th onclick="sortQuestions('accuracy')">Accuracy <span class="sort-icon">‚áÖ</span></th></tr></thead><tbody id="q-table-body"></tbody></table>
            </div>
            
            <div id="view-sessions" class="view-container">
                <table id="sessions-table"><thead><tr><th>Session Date</th><th>Duration</th><th>Questions</th><th>Accuracy</th><th></th></tr></thead><tbody id="sessions-table-body"></tbody></table>
            </div>
            
            <button onclick="logout()" style="background:#6c757d; margin-top:30px; font-size:0.8em;">LOGOUT</button>
        </div>
    </div>

    <div id="session-detail-modal"><div class="modal-content"><span class="close-btn" onclick="closeModal()">&times;</span><h2 id="modal-title">Session Details</h2><table id="session-detail-table"><thead><tr><th>Question</th><th>Result</th><th>Time</th></tr></thead><tbody id="session-detail-tbody"></tbody></table></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC3aHdoyrVWmOwnM5cEn3mueyEzG_QdBN0", authDomain: "super-math-tracker.firebaseapp.com", projectId: "super-math-tracker", storageBucket: "super-math-tracker.firebasestorage.app" };
        let db, auth;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();

            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('dashboard-section').style.display = 'block';
                    generateReport();
                } else {
                    document.getElementById('manual-login').style.display = 'flex';
                    document.querySelector('#login-section p').style.display = 'none';
                }
            });
        } catch(e) { console.error("Firebase Error", e); }

        function loginAndFetch() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, pass).catch(error => {
                document.getElementById('error-msg').innerText = error.message;
            });
        }

        function logout() {
            auth.signOut().then(() => { location.reload(); });
        }
        
        let globalLogs = [], categoryStats = [], questionStats = [], sessionStats = [];

        async function generateReport() {
            const snapshot = await db.collection("math_logs").orderBy("timestamp", "desc").get();
            globalLogs = snapshot.docs.map(doc => {
                const data = doc.data();
                return {...data, timestamp: new Date(data.timestamp.seconds * 1000)};
            });

            if(globalLogs.length === 0) {
                document.getElementById('cat-table-body').innerHTML = "<tr><td colspan='4'>No data yet.</td></tr>";
                return;
            }

            processData();
            renderSummary();
            renderCategoryTable();
            renderQuestionTable();
            renderSessionsTable();
        }

        function processData() {
            let catMap = {}, qMap = {}, sessionMap = {};
            let totalCorrect = 0;

            globalLogs.forEach(log => {
                if (!log.timestamp) return;
                const cat = log.category || "General";
                const qText = log.question || "Unknown";
                const isCorrect = (log.result === "Correct");
                if(isCorrect) totalCorrect++;

                if(!catMap[cat]) catMap[cat] = { name: cat, total: 0, correct: 0 };
                catMap[cat].total++;
                if(isCorrect) catMap[cat].correct++;

                if(!qMap[qText]) qMap[qText] = { text: qText, category: cat, total: 0, correct: 0, wrong: 0 };
                qMap[qText].total++;
                if(isCorrect) qMap[qText].correct++; else qMap[qText].wrong++;
                
                const sessionKey = log.sessionId || log.timestamp.toLocaleDateString();
                if(!sessionMap[sessionKey]) sessionMap[sessionKey] = { logs: [], startTime: log.timestamp, endTime: log.timestamp, total: 0, correct: 0 };
                sessionMap[sessionKey].logs.push(log);
                sessionMap[sessionKey].total++;
                if(isCorrect) sessionMap[sessionKey].correct++;
                if(log.timestamp < sessionMap[sessionKey].startTime) sessionMap[sessionKey].startTime = log.timestamp;
                if(log.timestamp > sessionMap[sessionKey].endTime) sessionMap[sessionKey].endTime = log.timestamp;
            });

            categoryStats = Object.values(catMap);
            questionStats = Object.values(qMap).map(q => ({...q, accuracy: (q.correct / q.total) * 100}));
            sessionStats = Object.values(sessionMap).sort((a,b) => b.startTime - a.startTime);
            
            document.getElementById('total-q').innerText = globalLogs.length;
            document.getElementById('total-acc').innerText = Math.round((totalCorrect / globalLogs.length) * 100) + "%";
            if(categoryStats.length > 0) {
                let bestCat = categoryStats.reduce((prev, curr) => ((prev.correct/prev.total) > (curr.correct/curr.total)) ? prev : curr);
                document.getElementById('top-subject').innerText = bestCat.name;
            }
            
            document.getElementById('total-sessions').innerText = sessionStats.length;
            if(sessionStats.length > 0) {
                let totalMinutes = sessionStats.reduce((acc, s) => acc + (s.endTime - s.startTime) / 60000, 0);
                document.getElementById('avg-duration').innerText = Math.round(totalMinutes / sessionStats.length) + "m";
            }
        }
        
        function renderSummary() {}

        function renderCategoryTable() {
            const tbody = document.getElementById('cat-table-body');
            tbody.innerHTML = "";
            categoryStats.sort((a,b) => b.total - a.total).forEach(row => {
                const perc = row.total > 0 ? Math.round((row.correct / row.total) * 100) : 0;
                let color = perc >= 80 ? "#28a745" : (perc >= 50 ? "#ffc107" : "#dc3545");
                tbody.innerHTML += `<tr><td style="font-weight:bold;">${row.name}</td><td>${row.total}</td><td>${perc}%</td><td style="width:30%;"><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${perc}%; background-color:${color};"></div></div></td></tr>`;
            });
        }

        function renderQuestionTable() {
            const tbody = document.getElementById('q-table-body');
            tbody.innerHTML = "";
            questionStats.forEach(q => {
                const acc = q.total > 0 ? Math.round(q.accuracy) : 0;
                tbody.innerHTML += `<tr><td>${q.text}</td><td>${q.category}</td><td>${q.total}</td><td>${q.correct}</td><td>${q.wrong > 0 ? `<span style="color:red; font-weight:bold;">${q.wrong}</span>` : "0"}</td><td class="'${acc < 60 ? 'bad-score' : ''}'">${acc}%</td></tr>`;
            });
        }
        
        function renderSessionsTable() {
            const tbody = document.getElementById('sessions-table-body');
            tbody.innerHTML = "";
            sessionStats.forEach((s, index) => {
                const duration = Math.max(1, Math.round((s.endTime - s.startTime) / 60000));
                const acc = s.total > 0 ? Math.round((s.correct / s.total) * 100) : 0;
                tbody.innerHTML += `<tr><td>${s.startTime.toLocaleDateString()} ${s.startTime.toLocaleTimeString()}</td><td>${duration} min</td><td>${s.total}</td><td>${acc}%</td><td><button onclick="viewSessionDetails(${index})">View</button></td></tr>`;
            });
        }

        function viewSessionDetails(index) {
            const session = sessionStats[index];
            session.logs.sort((a,b) => a.timestamp - b.timestamp);
            document.getElementById('modal-title').innerText = `Session on ${session.startTime.toLocaleDateString()}`;
            const tbody = document.getElementById('session-detail-tbody');
            tbody.innerHTML = "";
            session.logs.forEach(log => {
                tbody.innerHTML += `<tr><td>${log.question}</td><td style="color:${log.result === 'Correct' ? 'green':'red'}">${log.result}</td><td>${log.timestamp.toLocaleTimeString()}</td></tr>`;
            });
            document.getElementById('session-detail-modal').style.display = 'block';
        }

        function closeModal() { document.getElementById('session-detail-modal').style.display = 'none'; }

        let sortDir = {};
        function sortQuestions(key) {
            sortDir[key] = (sortDir[key] || 1) * -1;
            questionStats.sort((a,b) => (a[key] > b[key] ? 1 : -1) * sortDir[key]);
            renderQuestionTable();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn, .view-container').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`view-${tabName}`).classList.add('active');
        }

    </script>
</body>
</html>
