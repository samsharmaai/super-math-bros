<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mario Math: Parent Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Verdana&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Verdana', sans-serif; background: #f0f2f5; padding: 20px; text-align: center; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 5px; }
        .sub-header { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        
        /* LOGIN */
        #login-section { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 50px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 250px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }

        /* SUMMARY CARDS */
        #dashboard-section { display: none; text-align: left; }
        .summary-cards { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
        .card h3 { margin: 0; font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .card .number { font-size: 2.5em; font-weight: bold; color: #333; margin-top: 5px; }

        /* TABS navigation */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-btn {
            padding: 10px 20px; cursor: pointer; font-weight: bold; color: #666; border: none; background: none; font-size: 1em;
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .tab-btn:hover { color: #007bff; background: #f1f1f1; }
        .tab-btn.active { color: #007bff; border-bottom: 3px solid #007bff; }

        /* VIEW CONTAINERS */
        .view-container { display: none; animation: fadeIn 0.3s; }
        .view-container.active { display: block; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #007bff; color: white; position: sticky; top: 0; cursor: pointer; user-select: none; }
        th:hover { background-color: #0056b3; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e2e6ea; }

        .progress-bar-bg { width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; transition: width 0.5s; }

        .bad-score { color: red; font-weight: bold; }
        .good-score { color: green; font-weight: bold; }
        
        .sort-icon { font-size: 0.8em; margin-left: 5px; opacity: 0.7; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>üìä Parent Dashboard</h1>
        <div class="sub-header">Review Mario Math Performance</div>

        <div id="login-section">
            <p><strong>Checking Login...</strong></p>
            <div id="manual-login" style="display:none; flex-direction:column; align-items:center; gap:10px;">
                <input type="email" id="email" placeholder="Email" value="mario@math.com">
                <input type="password" id="password" placeholder="Password">
                <button onclick="loginAndFetch()">LOGIN</button>
                <p id="error-msg" style="color:red; font-size: 0.8em;"></p>
            </div>
        </div>

        <div id="dashboard-section">
            <div class="summary-cards">
                <div class="card">
                    <h3>Total Answered</h3>
                    <div class="number" id="total-q">0</div>
                </div>
                <div class="card">
                    <h3>Global Accuracy</h3>
                    <div class="number" id="total-acc">0%</div>
                </div>
                <div class="card">
                    <h3>Strongest Area</h3>
                    <div class="number" id="top-subject" style="font-size:1.2em; line-height: 2.5rem;">-</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('category')">üìÇ By Category</button>
                <button class="tab-btn" onclick="switchTab('questions')">‚ùì All Questions</button>
            </div>

            <div id="view-category" class="view-container active">
                <table id="category-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Attempts</th>
                            <th>Accuracy</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="cat-table-body">
                        </tbody>
                </table>
            </div>

            <div id="view-questions" class="view-container">
                <p style="font-size:0.8em; color:#666; margin-bottom:10px;">Click headers to sort.</p>
                <table id="questions-table">
                    <thead>
                        <tr>
                            <th onclick="sortQuestions('text')">Question <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortQuestions('category')">Category <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortQuestions('total')">Attempts <span class="sort-icon">‚ñº</span></th>
                            <th onclick="sortQuestions('correct')">Correct <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortQuestions('wrong')">Wrong <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortQuestions('accuracy')">Accuracy <span class="sort-icon">‚áÖ</span></th>
                        </tr>
                    </thead>
                    <tbody id="q-table-body">
                        </tbody>
                </table>
            </div>
            
            <button onclick="logout()" style="background:#6c757d; margin-top:30px; font-size:0.8em;">LOGOUT</button>
        </div>
    </div>

    <script>
        // --- BUILT-IN CREDENTIALS ---
        const firebaseConfig = {
            apiKey: "AIzaSyC3aHdoyrVWmOwnM5cEn3mueyEzG_QdBN0",
            authDomain: "super-math-tracker.firebaseapp.com",
            projectId: "super-math-tracker",
            storageBucket: "super-math-tracker.firebasestorage.app",
            messagingSenderId: "193983274782",
            appId: "1:193983274782:web:bab9f49ce52df2802e730f",
            measurementId: "G-RB7770405Z"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();
            var auth = firebase.auth();

            // --- AUTO LOGIN LISTENER ---
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log("Auto-login success");
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('dashboard-section').style.display = 'block';
                    generateReport();
                } else {
                    document.getElementById('manual-login').style.display = 'flex';
                    document.querySelector('#login-section p').style.display = 'none'; 
                }
            });

        } catch(e) { console.error("Firebase Error", e); }

        function loginAndFetch() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const btn = document.querySelector('#manual-login button');
            btn.innerText = "Verifying...";

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => { /* handled by listener */ })
                .catch((error) => {
                    btn.innerText = "LOGIN";
                    document.getElementById('error-msg').innerText = error.message;
                });
        }

        function logout() {
            auth.signOut().then(() => { location.reload(); });
        }

        // --- GLOBAL DATA VARS ---
        let globalLogs = [];
        let categoryStats = [];
        let questionStats = []; // Array of objects for easy sorting

        async function generateReport() {
            const snapshot = await db.collection("math_logs").get();
            globalLogs = snapshot.docs.map(doc => doc.data());

            if(globalLogs.length === 0) {
                document.getElementById('cat-table-body').innerHTML = "<tr><td colspan='4'>No data yet.</td></tr>";
                return;
            }

            processData();
            renderSummary();
            renderCategoryTable();
            renderQuestionTable();
        }

        function processData() {
            let catMap = {};
            let qMap = {};
            let totalCorrect = 0;

            globalLogs.forEach(log => {
                const cat = log.category || "General";
                const qText = log.question || "Unknown";
                const isCorrect = (log.result === "Correct");
                if(isCorrect) totalCorrect++;

                // Category Map
                if(!catMap[cat]) catMap[cat] = { name: cat, total: 0, correct: 0 };
                catMap[cat].total++;
                if(isCorrect) catMap[cat].correct++;

                // Question Map
                if(!qMap[qText]) qMap[qText] = { text: qText, category: cat, total: 0, correct: 0, wrong: 0 };
                qMap[qText].total++;
                if(isCorrect) qMap[qText].correct++;
                else qMap[qText].wrong++;
            });

            // Convert to Arrays
            categoryStats = Object.values(catMap);
            questionStats = Object.values(qMap);

            // Add accuracy to question objects for sorting
            questionStats.forEach(q => {
                q.accuracy = (q.correct / q.total) * 100;
            });

            // Global Summary Stats
            document.getElementById('total-q').innerText = globalLogs.length;
            document.getElementById('total-acc').innerText = Math.round((totalCorrect / globalLogs.length) * 100) + "%";
            
            let bestCat = categoryStats.reduce((prev, current) => {
                return ((prev.correct / prev.total) > (current.correct / current.total)) ? prev : current;
            });
            document.getElementById('top-subject').innerText = bestCat.name;
        }

        function renderSummary() {
            // Already handled inside processData for simplicity
        }

        function renderCategoryTable() {
            const tbody = document.getElementById('cat-table-body');
            tbody.innerHTML = "";

            categoryStats.forEach(row => {
                const percentage = Math.round((row.correct / row.total) * 100);
                let color = "#dc3545"; 
                if(percentage >= 50) color = "#ffc107"; 
                if(percentage >= 80) color = "#28a745"; 

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold;">${row.name}</td>
                    <td>${row.total}</td>
                    <td>${percentage}%</td>
                    <td style="width:30%;">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width:${percentage}%; background-color:${color};"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderQuestionTable() {
            const tbody = document.getElementById('q-table-body');
            tbody.innerHTML = "";

            questionStats.forEach(q => {
                const acc = Math.round(q.accuracy);
                let accClass = acc < 60 ? "bad-score" : (acc > 90 ? "good-score" : "");
                let wrongDisplay = q.wrong > 0 ? `<span style="color:red; font-weight:bold;">${q.wrong}</span>` : "0";

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${q.text}</td>
                    <td>${q.category}</td>
                    <td>${q.total}</td>
                    <td>${q.correct}</td>
                    <td>${wrongDisplay}</td>
                    <td class="${accClass}">${acc}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- SORTING LOGIC ---
        let sortDir = -1; // -1 = Descending (High to Low), 1 = Ascending
        function sortQuestions(key) {
            sortDir *= -1; // Toggle direction
            
            questionStats.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                
                // Case insensitive string sort
                if(typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return -1 * sortDir;
                if (valA > valB) return 1 * sortDir;
                return 0;
            });

            renderQuestionTable();
        }

        // --- TAB SWITCHING ---
        function switchTab(tabName) {
            // Update Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if(tabName === 'category') document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            else document.querySelector('.tab-btn:nth-child(2)').classList.add('active');

            // Update Views
            document.querySelectorAll('.view-container').forEach(div => div.classList.remove('active'));
            if(tabName === 'category') document.getElementById('view-category').classList.add('active');
            else document.getElementById('view-questions').classList.add('active');
        }

    </script>
</body>
</html>
